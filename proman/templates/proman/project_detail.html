{% extends "base.html" %}

{% block title %}Project: {{ project.name }}{% endblock title %}

{% block css %}
{{ block.super }}
<style>
    .log-field { font-weight: bold; }
    .log-change-old, .log-field-private, .log-field-non-billable { color: #a00; }
    .log-change-new, .log-field-public, .log-field-billable { color: #0a0; font-weight: bold; }
</style>
{% endblock css %}

{% block body %}
<div class="content project project-detail">
    <div class="page-header">
        <h1>{{ project.name }} <small class="colorize {{ project.status_class }}">{{ project.status|title }}</small></h1>
    </div>
    <div class="page-header">
        <div class="row">
        {% include "messages.html" %}
            <div class="span8">
                <h4>About the project:</h4>
                <p>{{ project.description|safe|linebreaks }}</p>
                <p>{{ project.harvest_notes }}</p>
            </div>
            <div class="span3 offset1">
                <p><strong>Owner:</strong> <a href="{% url user_detail project.owner.username %}">{{ project.owner.first_name }} {{ project.owner.last_name }}</a><br />
                <strong>Technology:</strong> {{ project.technology }}<br />
                <strong>Started:</strong> {{ project.start_dt|date:"n/j/Y" }}
                {% if project.ongoing %}<br /><span class="label warning">Non-Releasable</span>{% endif %}
                </p>
                <a class="btn primary" href="{% url project_update project.pk %}">Edit Project</a>
            </div>
        </div>
        <div class="row">
            <div class="span3">
                <h1><span class="colorize {{ project.perc_class }}">{{ project.task_done_count }}</span> / {{ project.task_count }}</h1><small>Done / Total Tasks</small>
            </div>
            <div class="span4">
                <h1><span class="colorize {{ project.perc_class }}">{% firstof project.task_done_hours|floatformat "0" %}</span> / {% firstof project.task_hours|floatformat "0" %} / {{ project.task_budget }}</h1><small>Done / Planned / Budgeted Hours</small>
            </div>
            <div class="span2">
                <h1 class="colorize {{ project.age_class }}">{{ project.age }}</h1><small>Days Old</small>
            </div>
        </div>
        <div class="row">
            <div class="span8">
                <div class="progress {{ project.perc_class }}">
                    <div class="bar" style="width: {{ project.completion_perc }}%;">{{ project.completion_perc }}%</div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="span8">
        <h2>Tasks <small><a href="{% url task_create %}?project={{ project.pk }}&next={{ request.path }}" class="colorize success">add new</a></small></h2>
        {% if project_tasks_stuck %}
            <h3>Stuck <small>{{ project_tasks_stuck|length }} Task{{ project_tasks_stuck|pluralize }}, {{ project_tasks_stuck_hours.total }} Hour{{ project_tasks_stuck_hours.total|pluralize }}</small></h3>
            <table id="task-list-done" class="table table-striped table-bordered table-condensed">
                <thead>
                <tr>
                    <th class="red">#</th>
                    <th class="red">Task</th>
                    <th class="red">Assigned To</th>
                    <th>Due on</th>
                    <th class="red">Hours</th>
                    <th>Edit</th>
                </tr>
                </thead>
                <tbody>
            {% for task in project_tasks_stuck %}
                <tr id="task-{{ task.pk }}">
                    <td>{{ task.pk }}</td>
                    <td><a href="{% url task_detail task.pk %}">{{ task.title }}</a></td>
                    <td><a href="{% url user_detail task.assignee.username %}">{{ task.assignee.first_name }} {{ task.assignee.last_name|slice:":1" }}.</a></td>
                    <td class="colorize {{ task.due_class }}">{{ task.due_dt|date:"m/d, D" }}</td>
                    <td>{{ task.task_time }}</td>
                    <td><a href="{% url task_update task.pk %}?next={{ request.path }}" class="label info">Edit</a></td>
                </tr>
            {% endfor %}
                </tbody>
            </table>
        {% endif %}

        {% if project_tasks_in_progress %}
            <h3>Tasks In Progress <small>{{ project_tasks_in_progress|length }} Task{{ project_tasks_in_progress|pluralize }}, {{ project_tasks_in_progress_hours.total }} Hour{{ project_tasks_in_progress_hours.total|pluralize }}</small></h3>
            <table id="task-list-in_progress" class="table table-striped table-bordered table-condensed">
                <thead>
                <tr>
                    <th class="blue">#</th>
                    <th class="blue">Task</th>
                    <th class="blue">Assigned To</th>
                    <th>Due on</th>
                    <th class="blue">Hours</th>
                    <th>Edit</th>
                </tr>
                </thead>
                <tbody>
            {% for task in project_tasks_in_progress %}
                <tr id="task-{{ task.pk }}">
                    <td>{{ task.pk }}</td>
                    <td><a href="{% url task_detail task.pk %}">{{ task.title }}</a></td>
                    <td><a href="{% url user_detail task.assignee.username %}">{{ task.assignee.first_name }} {{ task.assignee.last_name|slice:":1" }}.</a></td>
                    <td class="colorize {{ task.due_class }}">{{ task.due_dt|date:"m/d, D" }}</td>
                    <td>{{ task.task_time }}</td>
                    <td><a href="{% url task_update task.pk %}?next={{ request.path }}" class="label info">Edit</a></td>
                </tr>
            {% endfor %}
                </tbody>
            </table>
        {% endif %}
        
        {% if project_tasks_not_started %}
            <h3>Not Started <small>{{ project_tasks_not_started|length }} Task{{ project_tasks_not_started|pluralize }}, {{ project_tasks_not_started_hours.total }} Hour{{ project_tasks_not_started_hours.total|pluralize }}</small></h3>
            <table id="task-list-not-started" class="table table-striped table-bordered table-condensed">
                <thead>
                <tr>
                    <th class="orange">#</th>
                    <th class="orange">Task</th>
                    <th class="orange">Assigned To</th>
                    <th>Due on</th>
                    <th class="orange">Hours</th>
                    <th>Edit</th>
                </tr>
                </thead>
                <tbody>
            {% for task in project_tasks_not_started %}
                <tr id="task-{{ task.pk }}">
                    <td>{{ task.pk }}</td>
                    <td><a href="{% url task_detail task.pk %}">{{ task.title }}</a></td>
                    <td><a href="{% url user_detail task.assignee.username %}">{{ task.assignee.first_name }} {{ task.assignee.last_name|slice:":1" }}.</a></td>
                    <td class="colorize {{ task.due_class }}">{{ task.due_dt|date:"m/d, D" }}</td>
                    <td>{{ task.task_time }}</td>
                    <td><a href="{% url task_update task.pk %}?next={{ request.path }}" class="label info">Edit</a></td>
                </tr>
            {% endfor %}
                </tbody>
            </table>
        {% endif %}
        
        {% if project_tasks_done %}
            <h3>Done <small>{{ project_tasks_done|length }} Task{{ project_tasks_done|pluralize }}, {{ project_tasks_done_hours.total }} Hour{{ project_tasks_done_hours.total|pluralize }}</small></h3>
            <table id="task-list-done" class="table table-striped table-bordered table-condensed">
                <thead>
                <tr>
                    <th class="green">#</th>
                    <th class="green">Task</th>
                    <th class="green">Assigned To</th>
                    <th>Due on</th>
                    <th class="green">Hours</th>
                    <th>Edit</th>
                </tr>
                </thead>
                <tbody>
            {% for task in project_tasks_done %}
                <tr id="task-{{ task.pk }}">
                    <td>{{ forloop.counter }}</td>
                    <td><a href="{% url task_detail task.pk %}">{{ task.title }}</a></td>
                    <td><a href="{% url user_detail task.assignee.username %}">{{ task.assignee.first_name }} {{ task.assignee.last_name|slice:":1" }}.</a></td>
                    <td>{{ task.due_dt|date:"m/d, D" }}</td>
                    <td>{{ task.task_time }}</td>
                    <td><a href="{% url task_update task.pk %}?next={{ request.path }}" class="label info">Edit</a></td>
                </tr>
            {% endfor %}
                </tbody>
            </table>
        {% endif %}
            <div id="change-logs">
                <h3>Project changelog</h3>
                {% include "proman/log_items.html" with logs=project_logs %}
            </div>
        </div>
        
        <div class="span3 offset1">
            <form method="post" action="{% url task_create %}?project={{ project.pk }}&next={{ request.path }}" class="form-inline">{% csrf_token %}
                <legend>Task Quick Add</legend>
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                {% for field in form.visible_fields %}
                    <div class="control-group">
                    <label class="control-label" for="{{ field.label }}">{{ field.label }}</label>
                    <div class="controls">
                        {{ field }}
                        <p class="help-block">{{ field.errors }}</p>
                    </div>
                </div>
                {% endfor %}
                <div class="form-actions">
                    <button type="submit" class="btn success">Create a Task</button>
                    <button type="reset" class="btn">Cancel</button>
                </div>
                </form>
        </div>
    </div>
</div>
{% endblock body %}

{% block js %}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tablesorter.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
        $(".table-striped").tablesorter({
            sortList: [[0,0]],
            headers: { 5: { sorter: false}, 3: { sorter: false}, }
        });
        $('[class*=" task-"]').each(function(){
            var obj = $(this).attr('class').split(' ')[5];
            console.log(obj);
            objid = obj.split('-')[1];
            console.log(objid)
            $("#task-"+objid).children().css('background-color','#DFF0D8');
        });
        $( "#id_due_dt" ).datepicker();
});
</script>
{% endblock js %}