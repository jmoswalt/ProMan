{% extends "base.html" %}

{% load proman_tags %}
{% load humanize %}
{% load proman_filters %}

{% block title %}Project: {{ project.name }}{% endblock title %}

{% block css %}
{{ block.super }}
<style>
    .log-field { font-weight: bold; }
    .log-change-old, .log-field-private, .log-field-non-billable { color: #a00; }
    .log-change-new, .log-field-public, .log-field-billable { color: #0a0; font-weight: bold; }
    #project-name { font-size: 20px; }
    .table .label {font-size: 8.75px; display: none; margin-right: 6px;}
tr:hover .label { display: inline; padding: 0px 4px 0px;}
/*tr:hover td { padding: 3px 5px; }*/
.log-items {display: none; }
td.red { font-weight: bold; }
tr.stuck { background-color: #fadada; }
</style>
{% endblock css %}

{% block body %}
<div class="content project project-detail">
    <div class="page-header">
        <h1>{{ project.cached_client_name }} <small>{{ project.name }}</small></h1>
    </div>
    <div class="page-header">
        <div class="row">
        {% include "messages.html" %}
            <div class="span7">
                <div class="row">
                    <div class="span3">
                        <h1 class="colorize {{ project.perc_class }}">{{ project.completion_perc }}%</h1><small>Completed</small>
                    </div>
                    <div class="span2">
                        <h1 class="colorize {{ project.score_class }}">{{ project.score }}</h1><small>Watch</small>
                    </div>
                    <div class="span2" style="text-align: right;">
                        <h1 class="colorize {{ project.age_class }}">{{ project.age }}</h1><small>Days Old</small>
                    </div>
                    {% harvest_progress_bar project %}
                </div>
                <div class="row">
                    <div class="span3">
                        <h4 class="colorize {{ project.status_class }}">{{ project.status|title }}</h4>
                        <p><strong>Owner:</strong> <a href="{{ cached_owner_url }}">{{ project.cached_owner_name }}</a></p>
                        <p><a class="btn primary" href="{% url project_update project.pk %}">Edit Project</a></p>
                        
                    </div>
                    <div class="span4">
                        <p><strong>Technology:</strong> {{ project.technology }}<br />
                        <strong>Started:</strong> {{ project.start_dt|date:"n/j/Y" }}
                        {% if project.ongoing %}<br /><span class="label warning">Ongoing</span>{% endif %}
                        </p>
                        {% if project.description %}<h4>About the project:</h4>
                        <p>{{ project.description|safe|linebreaks }}</p>{% endif %}
                    </div>
                </div>
            </div>
            <div class="span4 pull-right well">
                <h3>Latest Activity</h3>
                <ul>
                {% for item in project.tasks_logs %}
                <li><a href="{% url task_detail item.object_id %}">{{ item.object_id|task_name }}</a>
                {% if item.action_flag == 1 %} was <strong>added</strong>
                {% elif item.action_flag == 5 %} was <strong>closed</strong>
                {% else %} <strong>deadline missed</strong>
                {% endif %} {{ item.action_time|naturaltime }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="span7">
        <h2>Tasks <small><a href="{% url task_create %}?project={{ project.pk }}&next={{ request.path }}" class="colorize success">add new</a></small></h2>
            <div {% if not project.tasks_not_done %}style="display: none;"{% endif %}>
                <h3>Not Started <small>{{ project.tasks_not_done_count }} Task{{ project.tasks_not_done_count|pluralize }}, {{ project.tasks_not_done_hours }} Hour{{ project.tasks_not_done_hours|pluralize }}</small></h3>
                <table id="task-list-not-done" class="table table-striped table-bordered table-condensed">
                    {% include "proman/project_task_table_header.html" with class="orange" dt="Due on" %}
                    {% include "proman/project_task_table_items.html" with tasks=project.tasks_not_done %}
                </table>
            </div>

            <div {% if not project.tasks_done %}style="display: none;"{% endif %}>
                <h3>Done <small>{{ project.tasks_done_count }} Task{{ project.tasks_done_count|pluralize }}, {{ project.tasks_done_hours }} Hour{{ project.tasks_done_hours|pluralize }}</small></h3>
                <table id="task-list-done" class="table table-striped table-bordered table-condensed">
                    {% include "proman/project_task_table_header.html" with class="green" dt="Done" %}
                    {% include "proman/project_task_table_items.html" with tasks=project.tasks_done %}
                </table>
            </div>

            <div id="change-logs">
                <h3>Project Changelog {% if project_logs %}<small><a id="toggle-logs" href="javascript:;">Toggle Logs</a></small>{% endif %}</h3>
                {% if project_logs %}
                {% include "proman/log_items.html" with logs=project_logs %}
                {% else %}
                <p>No logs yet</p>
                {% endif %}
            </div>
        </div>
        
        <div class="span4 pull-right well">
            <form method="post" action="{% url task_create %}?project={{ project.pk }}&next={{ request.path }}" class="form-inline">{% csrf_token %}
                <legend>Task Quick Add</legend>
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                {% for field in form.visible_fields %}
                    <div class="control-group">
                    <label class="control-label" for="{{ field.label }}">{{ field.label }}</label>
                    <div class="controls">
                        {{ field }}
                        <p class="help-block">{{ field.errors }}</p>
                    </div>
                </div>
                {% endfor %}
                <div class="form-actions">
                    <button type="submit" class="btn success">Create a Task</button>
                    <button type="reset" class="btn">Cancel</button>
                </div>
                </form>
        </div>
    </div>
</div>
{% endblock body %}

{% block js %}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tablesorter.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
        $("#task-list-done").tablesorter({
            sortList: [[2,1]],
        });
        $("#task-list-not-done").tablesorter({
            sortList: [[2,0]],
        });
        $('[class*=" task-"]').each(function(){
            var obj = $(this).attr('class').split(' ')[5];
            console.log(obj);
            objid = obj.split('-')[1];
            console.log(objid)
            $("#task-"+objid).children().css('background-color','#DFF0D8');
        });
        $( "#id_due_dt" ).datepicker();
        $('#toggle-logs').on('click', function() {
            $('.log-items').toggle();
        });
});
</script>
{% endblock js %}